# Pre-commit hooks for filipino-morphology-llm
# Install: pip install pre-commit && pre-commit install
# Run manually: pre-commit run --all-files

repos:
  # Code formatting
  - repo: https://github.com/psf/black
    rev: 24.3.0
    hooks:
      - id: black
        name: Format Python code with Black
        language_version: python3.11
        args: ['--line-length=100']
        exclude: ^(env/|cache/|container_cache/|nemo_experiments/|\.vscode/)

  # Import sorting
  - repo: https://github.com/PyCQA/isort
    rev: 5.13.2
    hooks:
      - id: isort
        name: Sort imports with isort
        args: ['--profile', 'black', '--line-length=100']
        exclude: ^(env/|cache/|container_cache/|nemo_experiments/|\.vscode/)

  # Remove trailing whitespace
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: trailing-whitespace
        name: Trim trailing whitespace
        exclude: ^(\.gitignore|.*\.md|env/|cache/)
        
      - id: end-of-file-fixer
        name: Fix end of files
        exclude: ^(env/|cache/|container_cache/|\.vscode/)
        
      - id: check-yaml
        name: Check YAML syntax
        exclude: ^(env/|cache/|container_cache/)
        
      - id: check-json
        name: Check JSON syntax
        exclude: ^(data/|env/|cache/|container_cache/|src/tokenization/expansions/)
        
      - id: check-added-large-files
        name: Check for large files (>5MB)
        args: ['--maxkb=5120']
        exclude: ^(data/|cache/|container_cache/|results/|logs/)
        
      - id: check-case-conflict
        name: Check for case conflicts
        
      - id: check-merge-conflict
        name: Check for merge conflicts
        
      - id: detect-private-key
        name: Detect private keys
        
      - id: mixed-line-ending
        name: Check mixed line endings
        args: ['--fix=lf']
        exclude: ^(env/|cache/|container_cache/)

  # Python linting
  - repo: https://github.com/PyCQA/flake8
    rev: 7.0.0
    hooks:
      - id: flake8
        name: Lint Python with Flake8
        args: [
          '--max-line-length=100',
          '--extend-ignore=E203,W503',  # Black-compatible
          '--exclude=env,cache,container_cache,nemo_experiments,.vscode'
        ]
        additional_dependencies: [flake8-docstrings]

  # Prevent committing to main
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: no-commit-to-branch
        name: Prevent direct commits to main
        args: ['--branch', 'main', '--branch', 'master']
        stages: [commit]

  # Custom hooks for this project
  - repo: local
    hooks:
      - id: check-large-json-expansions
        name: Check for large expansion JSONs in src/
        entry: bash
        args:
          - -c
          - >
            if find src/tokenization/expansions -name "*.json" -size +1M 2>/dev/null | grep -q .;
            then
              echo "ERROR: Large expansion JSON files found in src/tokenization/expansions/.";
              echo "These should be in data/expansions/ or gitignored.";
              exit 1;
            fi
        language: system
        pass_filenames: false
        
      - id: check-sys-path-pattern
        name: Check for inconsistent sys.path patterns
        entry: bash
        args:
          - -c
          - >
            if git diff --cached --name-only --diff-filter=AM | xargs grep -l 'sys\.path\.insert(0, "src")' 2>/dev/null;
            then
              echo "ERROR: Found old sys.path pattern.";
              echo 'Use: sys.path.insert(0, str(Path(__file__).parent.parent / "src"))';
              exit 1;
            fi
        language: system
        pass_filenames: false

      - id: check-test-naming
        name: Check test file naming convention  
        entry: bash
        args:
          - -c
          - >
            for f in tests/*.py; do
              if [[ -f "$f" && ! "$f" =~ tests/(test_|__init__|conftest|demo_) ]]; then
                echo "ERROR: Test file $f does not follow test_*.py convention";
                exit 1;
              fi;
            done
        language: system
        pass_filenames: false

# Configuration for black
exclude: |
  (?x)^(
    env/.*|
    cache/.*|
    container_cache/.*|
    nemo_experiments/.*|
    \.vscode/.*|
    data/expansions/.*\.json|
    src/tokenization/expansions/.*\.json
  )$
