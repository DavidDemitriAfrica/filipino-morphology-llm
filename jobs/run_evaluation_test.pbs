#!/bin/bash

#PBS -N eval_test
#PBS -l select=1:ncpus=8:ngpus=1:mem=32GB
#PBS -l walltime=01:00:00
#PBS -q AISG_debug
#PBS -j oe
#PBS -o /scratch_aisg/SPEC-SF-AISG/railey/logs/

# ============================================================================
# PBS Job Script for Quick Evaluation Test
# ============================================================================
#
# This script runs a quick evaluation test with a small model and limited samples.
# Use this to verify that the evaluation pipeline works before running the full batch.
#
# Usage:
#   qsub jobs/run_evaluation_test.pbs
#
# To test with different model:
#   qsub -v TEST_MODEL=qwen-2.5-0.5b jobs/run_evaluation_test.pbs
#
# ============================================================================

set -euo pipefail

# ============================================================================
# Setup Environment
# ============================================================================

export JOB_WORK_DIR=${PBS_O_WORKDIR}
export JOB_ID=${PBS_JOBID}
export JOB_NAME=${PBS_JOBNAME}

cd ${JOB_WORK_DIR}

# Load conda environment
if [ -f "${JOB_WORK_DIR}/env/bin/activate" ]; then
    echo "Activating conda environment..."
    source "${JOB_WORK_DIR}/env/bin/activate"
else
    echo "Error: Conda environment not found at ${JOB_WORK_DIR}/env"
    exit 1
fi

# ============================================================================
# Directory Setup
# ============================================================================

export LOG_DIR="/scratch_aisg/SPEC-SF-AISG/railey/logs/evaluation/${JOB_ID}"
export OUTPUT_DIR="${JOB_WORK_DIR}/results/benchmark_evaluation"

mkdir -p ${LOG_DIR}
mkdir -p ${OUTPUT_DIR}

# ============================================================================
# Test Configuration
# ============================================================================

# Use small model and limited samples for quick testing
TEST_MODEL="${TEST_MODEL:-gpt2}"
TEST_BENCHMARKS="${TEST_BENCHMARKS:-pacute}"
MAX_SAMPLES="${MAX_SAMPLES:-100}"
DEVICE="${DEVICE:-cuda}"

# ============================================================================
# Print Configuration
# ============================================================================

echo "============================================================================"
echo "Quick Evaluation Test"
echo "============================================================================"
echo "Job ID: ${JOB_ID}"
echo "Working Directory: ${JOB_WORK_DIR}"
echo ""
echo "Test Model: ${TEST_MODEL}"
echo "Benchmarks: ${TEST_BENCHMARKS}"
echo "Max Samples: ${MAX_SAMPLES}"
echo "Device: ${DEVICE}"
echo ""
echo "Output Directory: ${OUTPUT_DIR}"
echo "Log Directory: ${LOG_DIR}"
echo "============================================================================"
echo ""

# ============================================================================
# Run Test Evaluation
# ============================================================================

echo "Running evaluation test..."
echo ""

python scripts/run_evaluation.py \
    --models ${TEST_MODEL} \
    --benchmarks ${TEST_BENCHMARKS} \
    --max-samples ${MAX_SAMPLES} \
    --output-dir ${OUTPUT_DIR} \
    --device ${DEVICE} 2>&1 | tee ${LOG_DIR}/evaluation_test.log

EXIT_CODE=${PIPESTATUS[0]}

# ============================================================================
# Summary
# ============================================================================

echo ""
echo "============================================================================"
echo "Test Summary"
echo "============================================================================"

if [ ${EXIT_CODE} -eq 0 ]; then
    echo "✓ Evaluation test completed successfully!"
    echo ""
    echo "Results saved to: ${OUTPUT_DIR}"
    echo "Log saved to: ${LOG_DIR}/evaluation_test.log"
    echo ""
    echo "To run full batch evaluation:"
    echo "  qsub jobs/run_evaluation_batch.pbs"
else
    echo "✗ Evaluation test failed with exit code ${EXIT_CODE}"
    echo ""
    echo "Check logs at: ${LOG_DIR}/evaluation_test.log"
fi

echo "============================================================================"

exit ${EXIT_CODE}
